#!/usr/bin/env --split-string=${JDK_HOME}/bin/java @Breccia/Web/imager/java_arguments \c [SS]
package Breccia.Web.imager; // [AFN]

// This command runs directly from the present source file, it needs no compiling.

import Breccia.parser.plain.BrecciaCursor;
import Breccia.XML.translator.BrecciaXCursor;
import java.io.IOException;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.List;

import static Breccia.Web.imager.Project.outDirectory;
import static java.lang.System.err;
import static java.lang.System.exit;
import static Java.Path.enslash;


/** A shell command to make a Web image.
  *
  *     @see <a href='http://reluk.ca/project/Breccia/Web/imager/bin/breccia-web-image.brec'>
  *       The `breccia-web-image` command</a>
  */
public final class BrecciaWebImageCommand implements AutoCloseable { // [AFN]


    /** @param argsO Nominal arguments, aka options.
      * @param argsP Positional arguments.
      */
    private BrecciaWebImageCommand( final  List<String> argsO, final List<String> argsP ) {
        int aN = argsP.size();
        if( aN != 1 ) {
            err.println( "breccia-web-image: Expecting 1 argument, found " + aN );
            exitWithUsage( 1 ); }
        boundaryPath = Path.of(argsP.get(0)).toAbsolutePath();
        aN = argsO.size();
        for( int a = 0; a < aN; ++a ) {
            final String arg = argsO.get( a );
            String s;
            if( arg.startsWith( s = "--centre-column" )) opt.centreColumn = value( arg, s );
            else if( arg.startsWith( s = "--co-service-directory=" )) {
                opt.coServiceDirectory = enslash( value( arg, s )); }
            else if( arg.startsWith( s = "--font" )) opt.font = value( arg, s );
            else if( arg.startsWith( "--force" )) opt.toForce = true;
            else if( arg.startsWith( s = "--glyph-test-font" )) opt.glyphTestFont = value( arg, s );
            else {
                err.println( "breccia-web-image: Unrecognized argument: " + arg );
                exit( 1 ); }}}



    /** Takes a `breccia-web-image` command from the shell and executes it.
      */
    public static void main( final String[] arguments ) {
        final var argsO = new ArrayList<String>();
        final var argsP = new ArrayList<String>();
        for( int a = 0, aN = arguments.length; a < aN; ++a ) {
            final String arg = arguments[a];
            exitOnDemand( arg );
            (arg.startsWith("--") ? argsO : argsP).add( arg ); }
        try( final var command = new BrecciaWebImageCommand( argsO, argsP )) {
            if( !command.run() ) exit( 1 ); }}



   // ━━━  A u t o   C l o s e a b l e  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


    public @Override void close() { sourceTranslator.close(); }



////  P r i v a t e  ////////////////////////////////////////////////////////////////////////////////////


    private final Path boundaryPath;



    private static void exitOnDemand( final String arg ) {
        if( arg.equals("-?") || arg.equals("--help") ) exitWithUsage( 0 ); }



    private static void exitWithUsage( final int status ) {
        err.println( "Usage: breccia-web-image [<options>] <boundary path>" );
        err.println( "       breccia-web-image --help | -?" );
        err.println( "Options, one or more of:" );
        err.println( "    --centre-column=<number>" );
        err.println( "    --co-service-directory=<URI reference>" );
        err.println( "    --font=<relative file path>" );
        err.println( "    --force" );
        err.println( "    --glyph-test-font=<file path> | none" );
        exit( status ); }



    private final ImagingOptions opt = new ImagingOptions();



    /** @return True on success, false on failure.
      */
    private boolean run() {
        return Imaging.image( "breccia-web-image", boundaryPath, opt, new TransformerMaker(),
          outDirectory ); }



    private final BrecciaXCursor sourceTranslator = new BrecciaXCursor();



    /** @param arg A nominal argument, aka option.
      * @param prefix The leading name and equals sign, e.g. "foo=".
      */
    private static String value( final String arg, final String prefix ) {
        return arg.substring( prefix.length() ); }



   // ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀


    private final class TransformerMaker implements FileTransformer.Maker<BrecciaCursor> {


        public @Override FileTransformer<BrecciaCursor> newTransformer(
              ImageMould<BrecciaCursor> mould ) {
            return new BrecciaHTMLTransformer<>( new BrecciaCursor(), sourceTranslator, mould ); }}}



// NOTES
// ─────
//   AFN  Atypical file naming is allowed here.  ‘The compiler does not enforce the optional restriction
//        defined at the end of JLS §7.6, that a type in a named package should exist in a file whose
//        name is composed from the type name followed by the .java extension.’
//        http://openjdk.java.net/jeps/330
//        https://docs.oracle.com/javase/specs/jls/se15/html/jls-7.html#jls-7.6
//
//   SS · Here the long form `--split-string` (as opposed to `-S`) enables Emacs to recognize this file
//        as Java source code.  See the note apropos of ‘source-launch files encoded with a shebang’ at
//        `http://reluk.ca/project/Java/Emacs/jmt-mode.el`.



                                                   // Copyright © 2020-2022  Michael Allan.  Licence MIT.
